/*
 * @license
 * chartjs-plugin-streaming
 * http://github.com/nagix/chartjs-plugin-streaming/
 * Version: 1.1.0
 *
 * Copyright 2017 Akihiko Kusanagi
 * Released under the MIT license
 * https://github.com/nagix/chartjs-plugin-streaming/blob/master/LICENSE.md
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("chart.js"),require("moment")):"function"==typeof define&&define.amd?define(["chart.js","moment"],t):e["chartjs-plugin-streaming"]=t(e.Chart,e.moment)}(this,function(e,t){"use strict";e=e&&"default"in e?e.default:e,t=t&&"default"in t?t.default:t;!function(e,t){function a(e){return null!==e&&"[object Object]"===Object.prototype.toString.call(e)}function i(e,t){return void 0===e?t:e}function r(e){if(m.isArray(e))return e.map(r);if(a(e)){for(var t={},i=Object.keys(e),n=i.length,o=0;o<n;++o)t[i[o]]=r(e[i[o]]);return t}return e}function n(e,t,i,n){var o=t[e],s=i[e];a(o)&&a(s)?m.merge(o,s,n):t[e]=r(s)}function o(e,a,i){var r=[];if(e.maxTicks){var n=e.stepSize,o=void 0!==e.min?e.min:i.min,s=e.majorUnit,l=(s?t(o).add(1,s).startOf(s):o).valueOf()-o,u=d[e.unit].size*n,c=l%u,f=o;c&&s&&!e.timeOpts.round&&!e.timeOpts.isoWeekday?(f+=c-u,r.push(f)):r.push(o);for(var m=t(f),p=e.max||i.max;m.add(n,e.unit).valueOf()<p;)r.push(m.valueOf());r.push(m.valueOf())}return r}function s(e,t,a,i){for(var r,n=Object.keys(d),o=n.length,s=n.indexOf(e);s<o;s++){r=n[s];var l=d[r],u=l.steps&&l.steps[l.steps.length-1]||l.maxStep;if(void 0===u||Math.ceil((a-t)/(u*l.size))<=i)break}return r}function l(e){for(var t=Object.keys(d),a=t.indexOf(e);a<t.length;){var i=t[++a];if("week"!==i&&"quarter"!==i)return i}return null}function u(e,t,a,i){var r=d[a],n=r.size,o=Math.ceil((t-e)/n),s=1,l=t-e;if(r.steps)for(var u=r.steps.length,c=0;c<u&&o>i;c++)s=r.steps[c],o=Math.ceil(l/(n*s));else for(;o>i&&i>0;)++s,o=Math.ceil(l/(n*s));return s}function c(e,a){var i,r,n=e.timeOpts.isoWeekday;return"week"===e.unit&&!1!==n?(i=t(a.min).startOf("isoWeek").isoWeekday(n).valueOf(),r=t(a.max).startOf("isoWeek").isoWeekday(n),a.max-r>0&&r.add(1,"week"),r=r.valueOf()):(i=t(a.min).startOf(e.unit).valueOf(),r=t(a.max).startOf(e.unit),a.max-r>0&&r.add(1,e.unit),r=r.valueOf()),o(e,a,{min:i,max:r})}function f(e,t,a){for(var i=e._start||{},r=e._view||{},n=e._model||{},o=t.length,s=0;s<o;++s){var l=t[s];i.hasOwnProperty(l)&&(i[l]-=a),r.hasOwnProperty(l)&&r!==i&&(r[l]-=a),n.hasOwnProperty(l)&&n!==r&&(n[l]-=a)}}var m=e.helpers,p={position:"bottom",time:{parser:!1,format:!1,unit:!1,round:!1,displayFormat:!1,isoWeekday:!1,minUnit:"millisecond",displayFormats:{millisecond:"h:mm:ss.SSS a",second:"h:mm:ss a",minute:"h:mm a",hour:"hA",day:"MMM D",week:"ll",month:"MMM YYYY",quarter:"[Q]Q - YYYY",year:"YYYY"}},realtime:{duration:1e4,refresh:1e3,delay:0,onRefresh:null},ticks:{autoSkip:!1}};m.merge=function(e,t,i){var r,o,s,l,u,c=m.isArray(t)?t:[t],f=c.length;if(!a(e))return e;for(r=(i=i||{}).merger||n,o=0;o<f;++o)if(t=c[o],a(t))for(u=0,l=(s=Object.keys(t)).length;u<l;++u)r(s[u],e,t,i);return e},m.scaleMerge=function(){return m.merge(r(arguments[0]),[].slice.call(arguments,1),{merger:function(t,a,r,o){if("xAxes"===t||"yAxes"===t){var s,l,u,c,f=r[t].length;for(a[t]||(a[t]=[]),s=0;s<f;++s)l=i((u=r[t][s]).type,"xAxes"===t?"category":"linear"),c=e.scaleService.getScaleDefaults(l),s>=a[t].length&&a[t].push({}),!a[t][s].type||u.type&&u.type!==a[t][s].type?m.merge(a[t][s],[c,u]):m.merge(a[t][s],u)}else n(t,a,r,o)}})};var d={millisecond:{size:1,steps:[1,2,5,10,20,50,100,250,500]},second:{size:1e3,steps:[1,2,5,10,30]},minute:{size:6e4,steps:[1,2,5,10,30]},hour:{size:36e5,steps:[1,2,3,6,12]},day:{size:864e5,steps:[1,2,5]},week:{size:6048e5,maxStep:4},month:{size:2628e6,maxStep:3},quarter:{size:7884e6,maxStep:4},year:{size:3154e7,maxStep:!1}},h={x:{data:["x","controlPointPreviousX","controlPointNextX"],dataset:["x"],tooltip:["x","caretX"]},y:{data:["y","controlPointPreviousY","controlPointNextY"],dataset:["y"],tooltip:["y","caretY"]}},v=e.scaleService.getScaleConstructor("time");e.scaleService.getScaleConstructor=function(e){return"time"===e&&(e="realtime"),this.constructors.hasOwnProperty(e)?this.constructors[e]:void 0};var y=v.extend({initialize:function(){v.prototype.initialize.call(this);var e=this,t=e.options;if("time"!==t.type||e.chart.options.plugins.streaming){var a=Date.now(),i=Date.now(),r=function(){var n,o,s=e.chart,l=t.realtime,u=l.duration,c=l.refresh;e.isHorizontal()?(o=e.width,n=h.x):(o=e.height,n=h.y);var p=Date.now(),d=o*(p-i)/u;m.each(s.data.datasets,function(e,t){for(var a=s.getDatasetMeta(t),i=a.data||[],r=i.length,o=0;o<r;++o)f(i[o],n.data,d);a.dataset&&f(a.dataset,n.dataset,d)}),f(s.tooltip,n.tooltip,d),p>=a?(a=p+c+(p-a)%c,l.onRefresh&&l.onRefresh.call(s,e),s.update()):(e.max=p-l.delay,e.min=e.max-u,s.animating||s.draw()),i=p,m.requestAnimFrame.call(window,r)};m.requestAnimFrame.call(window,r)}},buildTicks:function(){var e=this,t=e.options;if("time"!==t.type||e.chart.options.plugins.streaming){var a=t.time,r=t.realtime,n=Date.now()-r.delay,o=n-r.duration,f=e.getLabelCapacity(o),m=a.unit||s(a.minUnit,o,n,f),p=l(m);e.displayFormat=a.displayFormats[m],e.majorDisplayFormat=a.displayFormats[p],e.unit=m,e.majorUnit=p;var d=i(a.stepSize,a.unitStepSize)||u(o,n,m,f);e.ticks=c({maxTicks:f,min:o,max:n+r.refresh,stepSize:d,majorUnit:p,unit:m,timeOpts:a},{min:e.dataMin,max:e.dataMax}),e.max=n,e.min=o}else v.prototype.buildTicks.call(this)},draw:function(e){var t=this,a=t.chart;if("time"===t.options.type&&!a.options.plugins.streaming)return v.prototype.draw.call(this,e);var i=t.ctx,r=t.isHorizontal()?{left:e.left,top:0,right:e.right,bottom:a.height}:{left:0,top:e.top,right:a.width,bottom:e.bottom};m.canvas.clipArea(i,r),v.prototype.draw.call(this,e),m.canvas.unclipArea(i)},getPixelForOffset:function(e){var t=this;if("time"===t.options.type&&!t.chart.options.plugins.streaming)return v.prototype.getPixelForOffset.call(this,e);var a=t.max-t.min,i=a?(e-t.min)/a:0;return t.isHorizontal()?t.left+t.width*i:t.top+t.height*i}});e.scaleService.registerScaleType("realtime",y,p)}(e,t),e.plugins.getAll().forEach(function(t){if("filler"===t.id){var a=t.beforeDatasetDraw;t.beforeDatasetDraw=function(t,i){e.helpers.canvas.clipArea(t.ctx,t.chartArea),a(t,i),e.helpers.canvas.unclipArea(t.ctx)}}});var a=function(e,t){function a(e){var a=this,i=a.options.plugins.streaming,r=e.isHorizontal()?"x":"y",n=Date.now()-i.delay-i.duration-2*i.refresh;i.onRefresh&&i.onRefresh(a),a.data.datasets.forEach(function(e){for(var a=e.data,i=0;i<a.length&&!(t(a[i][r]).valueOf()>n);++i);a.splice(0,i)})}return e.defaults.global.plugins.streaming={duration:1e4,refresh:1e3,delay:0,onRefresh:null},{id:"streaming",beforeUpdate:function(e,t){var i=e.options,r=i.scales;i.elements.line.capBezierPoints=!1,r.xAxes.forEach(function(e){e.ticks.maxRotation=!1}),r.xAxes.concat(r.yAxes).forEach(function(e){if("realtime"===e.type||"time"===e.type){var i=e.realtime;i||(i=e.realtime={}),i.duration=t.duration,i.refresh=t.refresh,i.delay=t.delay,i.onRefresh=a}})},beforeDraw:function(e){var t=e.lastMouseMoveEvent;return t&&e.canvas.dispatchEvent(t.native),!0},beforeEvent:function(e,t){return"mousemove"===t.type?e.lastMouseMoveEvent=t:"mouseout"===t.type&&delete e.lastMouseMoveEvent,!0}}}(e,t);return e.plugins.register(a),a});