/*
 * @license
 * chartjs-plugin-streaming
 * https://github.com/nagix/chartjs-plugin-streaming/
 * Version: 1.6.0
 *
 * Copyright 2018 Akihiko Kusanagi
 * Released under the MIT license
 * https://github.com/nagix/chartjs-plugin-streaming/blob/master/LICENSE.md
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("chart.js"),require("moment")):"function"==typeof define&&define.amd?define(["chart.js","moment"],t):e["chartjs-plugin-streaming"]=t(e.Chart,e.moment)}(this,function(e,t){"use strict";!function(e,h){var b=e.helpers;b.cancelAnimFrame=function(){if("undefined"!=typeof window)return window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(e){return window.clearTimeout(e)}}();var t,i,v=Number.MAX_SAFE_INTEGER||9007199254740991,g={millisecond:{common:!0,size:1,steps:[1,2,5,10,20,50,100,250,500]},second:{common:!0,size:1e3,steps:[1,2,5,10,30]},minute:{common:!0,size:6e4,steps:[1,2,5,10,30]},hour:{common:!0,size:36e5,steps:[1,2,3,6,12]},day:{common:!0,size:864e5,steps:[1,2,5]},week:{common:!1,size:6048e5,steps:[1,2,3,4]},month:{common:!0,size:2628e6,steps:[1,2,3]},quarter:{common:!1,size:7884e6,steps:[1,2,3,4]},year:{common:!0,size:3154e7}},y=Object.keys(g);function x(e){for(var t=y.indexOf(e)+1,n=y.length;t<n;++t)if(g[y[t]].common)return y[t]}function p(e,t,n,i,a){var o,r=i.time,s=r.unit||function(e,t,n,i){var a,o,r,s=y.length;for(a=y.indexOf(e);a<s-1;++a)if(r=(o=g[y[a]]).steps?o.steps[o.steps.length-1]:v,o.common&&Math.ceil((n-t)/(r*o.size))<=i)return y[a];return y[s-1]}(r.minUnit,e,t,n),l=x(s),u=b.valueOrDefault(r.stepSize,r.unitStepSize),c="week"===s&&r.isoWeekday,d=g[s],m=h(e),p=h(t+a),f=[];for(u||(u=function(e,t,n,i){var a,o,r,s=t-e,l=g[n],u=l.size,c=l.steps;if(!c)return Math.ceil(s/(i*u));for(a=0,o=c.length;a<o&&(r=c[a],!(Math.ceil(s/(u*r))<=i));++a);return r}(e,t,s,n)),c&&(m=m.isoWeekday(c),p=p.isoWeekday(c)),m=m.startOf(c?"day":s),(p=p.startOf(c?"day":s))<t+a&&p.add(1,s),o=h(m),!l||c||r.round||(o.startOf(l),o.add(~~((m-o)/(d.size*u))*u,s));o<p;o.add(u,s))f.push(+o);return f.push(+o),f}void 0!==document.hidden?(t="hidden",i="visibilitychange"):void 0!==document.msHidden?(t="msHidden",i="msvisibilitychange"):void 0!==document.webkitHidden&&(t="webkitHidden",i="webkitvisibilitychange");var D={data:["x","controlPointPreviousX","controlPointNextX"],dataset:["x"],tooltip:["x","caretX"]},M={data:["y","controlPointPreviousY","controlPointNextY"],dataset:["y"],tooltip:["y","caretY"]};function A(e,t,n){var i,a,o=e._start||{},r=e._view||{},s=e._model||{};for(i=0,a=t.length;i<a;++i){var l=t[i];o.hasOwnProperty(l)&&(o[l]-=n),r.hasOwnProperty(l)&&r!==o&&(r[l]-=n),s.hasOwnProperty(l)&&s!==r&&(s[l]-=n)}}var f=e.scaleService.getScaleConstructor("time");e.scaleService.getScaleConstructor=function(e){return"time"===e&&(e="realtime"),this.constructors.hasOwnProperty(e)?this.constructors[e]:void 0};var n=f.extend({initialize:function(){var h=this,v=h.chart;if(f.prototype.initialize.apply(h,arguments),"time"!==h.options.type||v.options.plugins.streaming){var g=b.requestAnimFrame,y=h.realtime=h.realtime||{},x=0,e=function(){document[t]||(y.head=Date.now(),v.update({duration:0}))};document.addEventListener(i,e,!1),y.visibilityChangeListener=e;var w=function(){var o,e,r,t=b.valueOrDefault,n=h.options.realtime||{},i=v.options.plugins.streaming||{},a=t(n.duration,i.duration),s=t(n.delay,i.delay),l=t(n.frameRate,i.frameRate),u=h.id,c=v.tooltip,d=c._active,m=1e3/(Math.max(l,0)||30);h.isHorizontal()?(e=h.width,o=D):(e=h.height,o=M);var p=Date.now(),f=e*(p-y.head)/a;b.each(v.data.datasets,function(e,t){if(r=v.getDatasetMeta(t),u===r.xAxisID||u===r.yAxisID){var n,i,a=r.data||[];for(n=0,i=a.length;n<i;++n)A(a[n],o.data,f);r.dataset&&A(r.dataset,o.dataset,f)}}),d&&d[0]&&(r=v.getDatasetMeta(d[0]._datasetIndex),u!==r.xAxisID&&u!==r.yAxisID||A(c,o.tooltip,f)),h.max=h._table[1].time=p-s,h.min=h._table[0].time=h.max-a,x+m<=p&&(v.animating||c._start||v.draw(),v.streaming.onDraw(v),(x+=m)+m<=p&&(x=p)),y.head=p,y.frameRequestID=g.call(window,w)};y.head=Date.now(),y.frameRequestID=g.call(window,w)}},update:function(){var e=this,t=e.options,n=e.chart;if("time"===t.type&&!n.options.plugins.streaming)return f.prototype.update.apply(e,arguments);var i=e.realtime.frameRequestID,a=(n.options.plugins.streaming||{}).pause;return i||a?i&&a&&e.destroy():e.initialize(),f.prototype.update.apply(e,arguments)},buildTicks:function(){var e=this,t=e.options,n=e.chart;if("time"===t.type&&!n.options.plugins.streaming)return f.prototype.buildTicks.apply(e,arguments);var i=b.valueOrDefault,a=t.time,o=t.realtime||{},r=n.options.plugins.streaming||{},s=i(o.duration,r.duration),l=i(o.delay,r.delay),u=i(r.refresh,0),c=e.realtime.head-l,d=c-s,m=[];switch(t.ticks.source){case"data":m=e._timestamps.data;break;case"labels":m=e._timestamps.labels;break;case"auto":default:m=p(d,c,e.getLabelCapacity(d),t,u)}return e.min=d,e.max=c,e._unit=a.unit||function(e,t,n,i){var a,o,r=h.duration(h(i).diff(h(n)));for(a=y.length-1;a>=y.indexOf(t);a--)if(o=y[a],g[o].common&&r.as(o)>=e.length)return o;return y[t?y.indexOf(t):0]}(m,a.minUnit,e.min,e.max),e._majorUnit=x(e._unit),e._table=[{time:d,pos:0},{time:c,pos:1}],e._offsets={left:0,right:0},e._labelFormat=function(e,t){var n,i,a,o,r,s,l,u=e.length;for(n=0;n<u;n++){if(o=e[n],l=s=void 0,s=(r=t).parser,l=r.parser||r.format,0!==(i="function"==typeof s?s(o):"string"==typeof o&&"string"==typeof l?h(o,l):(o instanceof h||(o=h(o)),o.isValid()?o:"function"==typeof l?l(o):o)).millisecond())return"MMM D, YYYY h:mm:ss.SSS a";0===i.second()&&0===i.minute()&&0===i.hour()||(a=!0)}return a?"MMM D, YYYY h:mm:ss a":"MMM D, YYYY"}(e._timestamps.data,a),function(e,t){var n,i,a,o,r=[];for(n=0,i=e.length;n<i;++n)a=e[n],o=!!t&&a===+h(a).startOf(t),r.push({value:a,major:o});return r}(m,e._majorUnit)},fit:function(){var e=this,t=e.options;f.prototype.fit.apply(e,arguments),("time"!==t.type||e.chart.options.plugins.streaming)&&t.ticks.display&&t.display&&e.isHorizontal()&&(e.paddingLeft=3,e.paddingRight=3,e.handleMargins())},draw:function(e){var t=this,n=t.chart;if("time"!==t.options.type||n.options.plugins.streaming){var i=t.ctx,a=t.isHorizontal()?{left:e.left,top:0,right:e.right,bottom:n.height}:{left:0,top:e.top,right:n.width,bottom:e.bottom};b.canvas.clipArea(i,a),f.prototype.draw.apply(t,arguments),b.canvas.unclipArea(i)}else f.prototype.draw.apply(t,arguments)},destroy:function(){var e=this.realtime,t=e.visibilityChangeListener,n=e.frameRequestID;t&&(document.removeEventListener(i,t,!1),delete e.visibilityChangeListener),n&&(b.cancelAnimFrame.call(window,n),delete e.frameRequestID)}});e.scaleService.registerScaleType("realtime",n,{position:"bottom",distribution:"linear",bounds:"data",time:{parser:!1,format:!1,unit:!1,round:!1,displayFormat:!1,isoWeekday:!1,minUnit:"millisecond",displayFormats:{millisecond:"h:mm:ss.SSS a",second:"h:mm:ss a",minute:"h:mm a",hour:"hA",day:"MMM D",week:"ll",month:"MMM YYYY",quarter:"[Q]Q - YYYY",year:"YYYY"}},ticks:{autoSkip:!1,source:"auto",major:{enabled:!0}}})}(e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t);var n=function(c){var d=c.helpers;c.defaults.global.plugins.streaming={duration:1e4,delay:0,frameRate:30,refresh:1e3,onRefresh:null,pause:!1,ttl:void 0};var m=c.scaleService.getScaleConstructor("realtime");function p(e){var t,n=e.streaming.lastMouseEvent;n&&("function"==typeof MouseEvent?t=new MouseEvent("mousemove",n):(t=document.createEvent("MouseEvents")).initMouseEvent("mousemove",n.bubbles,n.cancelable,n.view,n.detail,n.screenX,n.screenY,n.clientX,n.clientY,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,n.button,n.relatedTarget),e.canvas.dispatchEvent(t))}var u=["pointBackgroundColor","pointBorderColor","pointBorderWidth","pointRadius","pointStyle","pointHitRadius","pointHoverBackgroundColor","pointHoverBorderColor","pointHoverBorderWidth","pointHoverRadius","backgroundColor","borderColor","borderWidth","hoverBackgroundColor","hoverBorderColor","hoverBorderWidth","hoverRadius","hitRadius","radius"];function f(e,t,n,i,a){var o,r,s=i.data,l=2;for(isNaN(n)||(t=e.getPixelForValue(Date.now()-n),l=0),o=l,r=s.length;o<r&&e.getPixelForValue(null,o,a)<=t;++o);if(s.splice(0,o-l),u.forEach(function(e){i.hasOwnProperty(e)&&d.isArray(i[e])&&i[e].splice(0,o-l)}),"object"!=typeof s[0])return o-l}function a(n){var i,a,o,r,e,t,s,l=n.options.plugins.streaming||{},u=l.ttl;l.onRefresh&&l.onRefresh(n),n.data.datasets.forEach(function(e,t){(i=n.getDatasetMeta(t)).xAxisID&&(a=i.controller.getScaleForId(i.xAxisID))instanceof m&&(o=f(a,a.left,u,e,t)),i.yAxisID&&(a=i.controller.getScaleForId(i.yAxisID))instanceof m&&(o=f(a,a.top,u,e,t))}),o&&n.data.labels.splice(0,o),e=(r=n).options.animation,t=r.data.datasets,s=r.buildOrUpdateControllers(),t.forEach(function(e,t){r.getDatasetMeta(t).controller.buildOrUpdateElements()}),r.updateLayout(),e&&e.duration&&d.each(s,function(e){e.reset()}),r.updateDatasets(),r.animating?c.animationService.animations.forEach(function(e){e.chart===r&&r.render({duration:16.66*(e.numSteps-e.currentStep)})}):t.forEach(function(e,t){r.getDatasetMeta(t).controller.transition(1)}),r.tooltip._active&&r.tooltip.update(!0),p(r)}function o(e){var t=e.streaming,n=t.refreshTimerID;n&&(clearInterval(n),delete t.refreshTimerID,delete t.refresh)}return{id:"streaming",beforeInit:function(e){var t=e.canvas,n=e.streaming=e.streaming||{},i=function(e){n.lastMouseEvent=e};t.addEventListener("mousedown",i),t.addEventListener("mouseup",i),n.mouseEventListener=i,n.onDraw=p},afterInit:function(e,t){!function t(n,e){var i=n.streaming;i.refreshTimerID=setInterval(function(){var e=(n.options.plugins.streaming||{}).refresh;a(n),i.refresh===e||isNaN(e)||(o(n),t(n,e))},e),i.refresh=e}(e,t.refresh)},beforeUpdate:function(e){var t=e.options,n=t.scales;return n&&n.xAxes.concat(n.yAxes).forEach(function(e){"realtime"!==e.type&&"time"!==e.type||(t.elements.line.capBezierPoints=!1)}),!0},beforeDatasetDraw:function(e,t){var n=t.meta,i=e.chartArea,a={left:0,top:0,right:e.width,bottom:e.height};return n.xAxisID&&n.controller.getScaleForId(n.xAxisID)instanceof m&&(a.left=i.left,a.right=i.right),n.yAxisID&&n.controller.getScaleForId(n.yAxisID)instanceof m&&(a.top=i.top,a.bottom=i.bottom),d.canvas.clipArea(e.ctx,a),!0},afterDatasetDraw:function(e){d.canvas.unclipArea(e.ctx)},beforeEvent:function(e,t){var n=e.streaming;return"mousemove"===t.type?n.lastMouseEvent=t.native:"mouseout"===t.type&&delete n.lastMouseEvent,!0},destroy:function(e){var t=e.canvas,n=e.streaming.mouseButtonListener;t.removeEventListener("mousedown",n),t.removeEventListener("mouseup",n),o(e),d.each(e.scales,function(e){e instanceof m&&e.destroy()})}}}(e);return e.plugins.register(n),function(e){var m=e.helpers,t=e.Zoom=e.Zoom||{};function p(e,t){if(e.scaleAxes&&e.rangeMax&&!m.isNullOrUndef(e.rangeMax[e.scaleAxes])){var n=e.rangeMax[e.scaleAxes];n<t&&(t=n)}return t}function f(e,t){if(e.scaleAxes&&e.rangeMin&&!m.isNullOrUndef(e.rangeMin[e.scaleAxes])){var n=e.rangeMin[e.scaleAxes];t<n&&(t=n)}return t}t.zoomFunctions=t.zoomFunctions||{},t.panFunctions=t.panFunctions||{},t.zoomFunctions.realtime=function(e,t,n,i){var a,o,r=e.options,s=r.realtime=r.realtime||{},l=e.chart.options.plugins.streaming||{},u=m.valueOrDefault(s.duration,l.duration),c=m.valueOrDefault(s.delay,l.delay),d=u*(2-t);a=e.isHorizontal()?(e.right-n.x)/(e.right-e.left):(e.bottom-n.y)/(e.bottom-e.top),o=t<1?p(i,d):f(i,d),s.duration=o,s.delay=c+a*(u-o)},t.panFunctions.realtime=function(e,t,n){var i=e.options,a=i.realtime=i.realtime||{},o=e.chart.options.plugins.streaming||{},r=m.valueOrDefault(a.delay,o.delay)+(e.getValueForPixel(t)-e.getValueForPixel(0));a.delay=0<t?p(n,r):f(n,r)}}(e),n});