/*
 * @license
 * chartjs-plugin-streaming
 * http://github.com/nagix/chartjs-plugin-streaming/
 * Version: 1.3.0
 *
 * Copyright 2018 Akihiko Kusanagi
 * Released under the MIT license
 * https://github.com/nagix/chartjs-plugin-streaming/blob/master/LICENSE.md
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("chart.js"),require("moment")):"function"==typeof define&&define.amd?define(["chart.js","moment"],e):t["chartjs-plugin-streaming"]=e(t.Chart,t.moment)}(this,function(t,e){"use strict";!function(t,e){var i=t.helpers,a=Number.MAX_SAFE_INTEGER||9007199254740991,o={millisecond:{common:!0,size:1,steps:[1,2,5,10,20,50,100,250,500]},second:{common:!0,size:1e3,steps:[1,2,5,10,30]},minute:{common:!0,size:6e4,steps:[1,2,5,10,30]},hour:{common:!0,size:36e5,steps:[1,2,3,6,12]},day:{common:!0,size:864e5,steps:[1,2,5]},week:{common:!1,size:6048e5,steps:[1,2,3,4]},month:{common:!0,size:2628e6,steps:[1,2,3]},quarter:{common:!1,size:7884e6,steps:[1,2,3,4]},year:{common:!0,size:3154e7}},n=Object.keys(o);function r(t){for(var e=n.indexOf(t)+1,i=n.length;e<i;++e)if(o[n[e]].common)return n[e]}function s(t,s,l,u){var m,c=u.time,d=c.unit||function(t,e,i,r){var s,l,u,m=n.length;for(s=n.indexOf(t);s<m-1;++s)if(u=(l=o[n[s]]).steps?l.steps[l.steps.length-1]:a,l.common&&Math.ceil((i-e)/(u*l.size))<=r)return n[s];return n[m-1]}(c.minUnit,t,s,l),f=r(d),p=i.valueOrDefault(c.stepSize,c.unitStepSize),h="week"===d&&c.isoWeekday,y=o[d],v=e(t),g=e(s+u.realtime.delay+u.realtime.refresh),b=[];for(p||(p=function(t,e,i,a){var n,r,s,l=e-t,u=o[i],m=u.size,c=u.steps;if(!c)return Math.ceil(l/(a*m));for(n=0,r=c.length;n<r&&(s=c[n],!(Math.ceil(l/(m*s))<=a));++n);return s}(t,s,d,l)),h&&(v=v.isoWeekday(h),g=g.isoWeekday(h)),v=v.startOf(h?"day":d),(g=g.startOf(h?"day":d))<s&&g.add(1,d),m=e(v),!f||h||c.round||(m.startOf(f),m.add(~~((v-m)/(y.size*p))*p,d));m<g;m.add(p,d))b.push(+m);return b.push(+m),b}var l={data:["x","controlPointPreviousX","controlPointNextX"],dataset:["x"],tooltip:["x","caretX"]},u={data:["y","controlPointPreviousY","controlPointNextY"],dataset:["y"],tooltip:["y","caretY"]};function m(t,e,i){var a,o,n=t._start||{},r=t._view||{},s=t._model||{};for(a=0,o=e.length;a<o;++a){var l=e[a];n.hasOwnProperty(l)&&(n[l]-=i),r.hasOwnProperty(l)&&r!==n&&(r[l]-=i),s.hasOwnProperty(l)&&s!==r&&(s[l]-=i)}}var c=t.scaleService.getScaleConstructor("time");t.scaleService.getScaleConstructor=function(t){return"time"===t&&(t="realtime"),this.constructors.hasOwnProperty(t)?this.constructors[t]:void 0};var d=c.extend({initialize:function(){c.prototype.initialize.call(this);var t=this,e=t.options;if("time"!==e.type||t.chart.options.plugins.streaming){var a=Date.now(),o=Date.now(),n=function(){var r,s,c=t.chart,d=e.realtime,f=d.duration,p=d.refresh;t.isHorizontal()?(s=t.width,r=l):(s=t.height,r=u);var h=Date.now(),y=s*(h-o)/f;i.each(c.data.datasets,function(t,e){var i,a,o=c.getDatasetMeta(e),n=o.data||[];for(i=0,a=n.length;i<a;++i)m(n[i],r.data,y);o.dataset&&m(o.dataset,r.dataset,y)}),m(c.tooltip,r.tooltip,y),h>=a?(a=h+p+(h-a)%p,d.onRefresh&&d.onRefresh.call(c,t),c.update()):(t.max=t._table[1].time=h-d.delay,t.min=t._table[0].time=t.max-f,c.animating||c.draw()),o=h,i.requestAnimFrame.call(window,n)};i.requestAnimFrame.call(window,n)}},buildTicks:function(){var t=this,i=t.options;if("time"!==i.type||t.chart.options.plugins.streaming){var a=i.time,l=i.realtime,u=Date.now()-l.delay,m=u-l.duration,d=[];switch(i.ticks.source){case"data":d=t._timestamps.data;break;case"labels":d=t._timestamps.labels;break;case"auto":default:d=s(m,u,t.getLabelCapacity(m),i)}return t.min=m,t.max=u,t._unit=a.unit||function(t,i,a,r){var s,l,u=e.duration(e(r).diff(e(a)));for(s=n.length-1;s>=n.indexOf(i);s--)if(l=n[s],o[l].common&&u.as(l)>=t.length)return l;return n[i?n.indexOf(i):0]}(d,a.minUnit,t.min,t.max),t._majorUnit=r(t._unit),t._table=[{time:m,pos:0},{time:u,pos:1}],t._offsets={left:0,right:0},t._labelFormat=function(t,i){var a,o,n,r,s,l,u,m=t.length;for(a=0;a<m;a++){if(r=t[a],l=void 0,u=void 0,l=(s=i).parser,u=s.parser||s.format,0!==(o="function"==typeof l?l(r):"string"==typeof r&&"string"==typeof u?e(r,u):(r instanceof e||(r=e(r)),r.isValid()?r:"function"==typeof u?u(r):r)).millisecond())return"MMM D, YYYY h:mm:ss.SSS a";0===o.second()&&0===o.minute()&&0===o.hour()||(n=!0)}return n?"MMM D, YYYY h:mm:ss a":"MMM D, YYYY"}(t._timestamps.data,a),function(t,i){var a,o,n,r,s=[];for(a=0,o=t.length;a<o;++a)n=t[a],r=!!i&&n===+e(n).startOf(i),s.push({value:n,major:r});return s}(d,t._majorUnit)}c.prototype.buildTicks.call(this)},fit:function(){c.prototype.fit.call(this);var t=this,e=t.options;e.ticks.display&&e.display&&t.isHorizontal()&&(t.paddingLeft=3,t.paddingRight=3,t.handleMargins())},draw:function(t){var e=this.chart;if("time"===this.options.type&&!e.options.plugins.streaming)return c.prototype.draw.call(this,t);var a=this.ctx,o=this.isHorizontal()?{left:t.left,top:0,right:t.right,bottom:e.height}:{left:0,top:t.top,right:e.width,bottom:t.bottom};i.canvas.clipArea(a,o),c.prototype.draw.call(this,t),i.canvas.unclipArea(a)}});t.scaleService.registerScaleType("realtime",d,{position:"bottom",distribution:"linear",bounds:"data",time:{parser:!1,format:!1,unit:!1,round:!1,displayFormat:!1,isoWeekday:!1,minUnit:"millisecond",displayFormats:{millisecond:"h:mm:ss.SSS a",second:"h:mm:ss a",minute:"h:mm a",hour:"hA",day:"MMM D",week:"ll",month:"MMM YYYY",quarter:"[Q]Q - YYYY",year:"YYYY"}},realtime:{duration:1e4,refresh:1e3,delay:0,onRefresh:null},ticks:{autoSkip:!1,source:"auto",major:{enabled:!0}}})}(t=t&&t.hasOwnProperty("default")?t.default:t,e=e&&e.hasOwnProperty("default")?e.default:e);var i=function(t){function e(t){var e,i,a,o,n=this.options.plugins.streaming,r=t.isHorizontal()?t.left:t.top;n.onRefresh&&n.onRefresh(this),this.data.datasets.forEach(function(n,s){for(e=n.data,i=2,a=e.length;i<a&&t.getPixelForValue(null,i,s)<=r;++i);e.splice(0,i-2),"object"!=typeof e[0]&&(o=i-2)}),o&&this.data.labels.splice(0,o)}return t.defaults.global.plugins.streaming={duration:1e4,refresh:1e3,delay:0,onRefresh:null},{id:"streaming",beforeUpdate:function(t,i){var a,o=t.options,n=o.scales;o.elements.line.capBezierPoints=!1,n.xAxes.concat(n.yAxes).forEach(function(t){"realtime"!==t.type&&"time"!==t.type||((a=t.realtime)||(a=t.realtime={}),a.duration=i.duration,a.refresh=i.refresh,a.delay=i.delay,a.onRefresh=e)})},beforeDraw:function(t){var e=t.lastMouseMoveEvent;return e&&t.canvas.dispatchEvent(e.native),!0},beforeEvent:function(t,e){return"mousemove"===e.type?t.lastMouseMoveEvent=e:"mouseout"===e.type&&delete t.lastMouseMoveEvent,!0}}}(t);return t.plugins.register(i),i});